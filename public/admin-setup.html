<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å‘˜æƒé™è®¾ç½® - MEDç¯å¢ƒæ•°æ®å¹³å°</title>
    <link rel="stylesheet" href="css/navbar.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/navbar.js"></script>
    <script src="js/supabase-config.js"></script>
</head>
<body class="bg-gray-50">
    <!-- å¯¼èˆªæ å®¹å™¨ -->
    <div id="navbar-container"></div>

    <div class="min-h-screen pt-16 py-12">
        <div class="max-w-4xl mx-auto px-4">
            <div class="bg-white rounded-lg shadow-lg p-8">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">ç®¡ç†å‘˜æƒé™è®¾ç½®</h1>
                <p class="text-gray-600 mb-8">è®¾ç½®ç”¨æˆ·çš„ç®¡ç†å‘˜æƒé™ï¼Œç”¨äºæµ‹è¯•ç®¡ç†é¢æ¿åŠŸèƒ½</p>

                <!-- å½“å‰ç”¨æˆ·ä¿¡æ¯ -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-8">
                    <h2 class="text-lg font-semibold text-blue-900 mb-4">å½“å‰ç”¨æˆ·ä¿¡æ¯</h2>
                    <div id="current-user-info" class="space-y-2">
                        <p class="text-blue-800">åŠ è½½ä¸­...</p>
                    </div>
                </div>

                <!-- æƒé™è®¾ç½®è¡¨å• -->
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">æƒé™æ“ä½œ</h2>
                    
                    <div class="space-y-6">
                        <!-- è®¾ç½®å½“å‰ç”¨æˆ·ä¸ºç®¡ç†å‘˜ -->
                        <div class="border-b border-gray-200 pb-6">
                            <h3 class="text-md font-medium text-gray-900 mb-3">è®¾ç½®å½“å‰ç”¨æˆ·æƒé™</h3>
                            <div class="flex items-center space-x-4">
                                <select id="role-select" class="border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500">
                                    <option value="user">æ™®é€šç”¨æˆ·</option>
                                    <option value="admin">ç®¡ç†å‘˜</option>
                                    <option value="super_admin">è¶…çº§ç®¡ç†å‘˜</option>
                                </select>
                                <button id="update-role-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md transition-colors">
                                    æ›´æ–°æƒé™
                                </button>
                            </div>
                            <p class="text-sm text-gray-500 mt-2">
                                è®¾ç½®ä¸ºç®¡ç†å‘˜åï¼Œæ‚¨å°†èƒ½å¤Ÿè®¿é—®ç®¡ç†é¢æ¿å¹¶ç®¡ç†å…¶ä»–ç”¨æˆ·
                            </p>
                        </div>

                        <!-- è®¾ç½®ç”¨æˆ·çŠ¶æ€ -->
                        <div class="border-b border-gray-200 pb-6">
                            <h3 class="text-md font-medium text-gray-900 mb-3">è®¾ç½®ç”¨æˆ·çŠ¶æ€</h3>
                            <div class="flex items-center space-x-4">
                                <select id="status-select" class="border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500">
                                    <option value="pending">å¾…å®¡æ ¸</option>
                                    <option value="approved">å·²é€šè¿‡</option>
                                    <option value="rejected">å·²æ‹’ç»</option>
                                    <option value="suspended">å·²æš‚åœ</option>
                                </select>
                                <button id="update-status-btn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md transition-colors">
                                    æ›´æ–°çŠ¶æ€
                                </button>
                            </div>
                            <p class="text-sm text-gray-500 mt-2">
                                åªæœ‰"å·²é€šè¿‡"çŠ¶æ€çš„ç”¨æˆ·æ‰èƒ½æ­£å¸¸ä½¿ç”¨å¹³å°åŠŸèƒ½
                            </p>
                        </div>

                        <!-- åˆ›å»ºæµ‹è¯•ç”¨æˆ· -->
                        <div>
                            <h3 class="text-md font-medium text-gray-900 mb-3">åˆ›å»ºæµ‹è¯•ç”¨æˆ·</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input id="test-email" type="email" placeholder="æµ‹è¯•ç”¨æˆ·é‚®ç®±" 
                                       class="border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500">
                                <input id="test-name" type="text" placeholder="æµ‹è¯•ç”¨æˆ·å§“å" 
                                       class="border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500">
                                <select id="test-status" class="border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500">
                                    <option value="pending">å¾…å®¡æ ¸</option>
                                    <option value="approved">å·²é€šè¿‡</option>
                                </select>
                                <button id="create-test-user-btn" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-md transition-colors">
                                    åˆ›å»ºæµ‹è¯•ç”¨æˆ·
                                </button>
                            </div>
                            <p class="text-sm text-gray-500 mt-2">
                                åˆ›å»ºæµ‹è¯•ç”¨æˆ·ç”¨äºæµ‹è¯•ç®¡ç†é¢æ¿çš„å®¡æ ¸åŠŸèƒ½
                            </p>
                        </div>
                    </div>
                </div>

                <!-- å¿«é€Ÿæ“ä½œæŒ‰é’® -->
                <div class="mt-8 flex flex-col sm:flex-row gap-4">
                    <a href="admin-dashboard.html" 
                       class="bg-indigo-500 hover:bg-indigo-600 text-white text-center px-6 py-3 rounded-md transition-colors">
                        ğŸ”§ æ‰“å¼€ç®¡ç†é¢æ¿
                    </a>
                    <button id="test-data-btn" 
                            class="bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-3 rounded-md transition-colors">
                        ğŸ“Š ç”Ÿæˆæµ‹è¯•æ•°æ®
                    </button>
                    <button id="clear-data-btn" 
                            class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-md transition-colors">
                        ğŸ—‘ï¸ æ¸…ç†æµ‹è¯•æ•°æ®
                    </button>
                </div>

                <!-- æ“ä½œæ—¥å¿— -->
                <div class="mt-8">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">æ“ä½œæ—¥å¿—</h2>
                    <div id="operation-log" class="bg-gray-50 border border-gray-200 rounded-lg p-4 h-40 overflow-y-auto">
                        <p class="text-gray-600 text-sm">æ“ä½œæ—¥å¿—å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–å¯¼èˆªæ 
        initNavbar({ 
            activeItem: 'service'
        });

        class AdminSetup {
            constructor() {
                this.currentUser = null;
                this.init();
            }

            async init() {
                try {
                    await this.loadCurrentUser();
                    this.bindEventListeners();
                } catch (error) {
                    this.log('åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
                }
            }

            async loadCurrentUser() {
                const { data: { user }, error } = await supabase.auth.getUser();
                
                if (error || !user) {
                    throw new Error('ç”¨æˆ·æœªç™»å½•');
                }

                this.currentUser = user;

                // è·å–ç”¨æˆ·profileä¿¡æ¯
                const { data: profile, error: profileError } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', user.id)
                    .single();

                if (profileError) {
                    // å¦‚æœprofileä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ª
                    const { error: insertError } = await supabase
                        .from('profiles')
                        .insert({
                            id: user.id,
                            email: user.email,
                            full_name: user.user_metadata?.full_name || user.email,
                            status: 'approved' // é»˜è®¤è®¾ä¸ºå·²é€šè¿‡
                        });

                    if (insertError) {
                        this.log('åˆ›å»ºç”¨æˆ·profileå¤±è´¥: ' + insertError.message, 'error');
                    } else {
                        this.log('å·²è‡ªåŠ¨åˆ›å»ºç”¨æˆ·profile', 'success');
                        // é‡æ–°è·å–profile
                        await this.loadCurrentUser();
                        return;
                    }
                }

                this.updateCurrentUserDisplay(user, profile);
                
                // æ›´æ–°é€‰æ‹©å™¨çš„å½“å‰å€¼
                if (profile) {
                    document.getElementById('role-select').value = profile.role || 'user';
                    document.getElementById('status-select').value = profile.status || 'pending';
                }
            }

            updateCurrentUserDisplay(user, profile) {
                const infoDiv = document.getElementById('current-user-info');
                infoDiv.innerHTML = `
                    <p><strong>é‚®ç®±:</strong> ${user.email}</p>
                    <p><strong>ç”¨æˆ·ID:</strong> ${user.id}</p>
                    <p><strong>å½“å‰è§’è‰²:</strong> ${this.getRoleText(profile?.role || 'user')}</p>
                    <p><strong>å½“å‰çŠ¶æ€:</strong> ${this.getStatusText(profile?.status || 'pending')}</p>
                    <p><strong>æ³¨å†Œæ—¶é—´:</strong> ${new Date(user.created_at).toLocaleString('zh-CN')}</p>
                `;
            }

            getRoleText(role) {
                const roleMap = {
                    user: 'æ™®é€šç”¨æˆ·',
                    admin: 'ç®¡ç†å‘˜',
                    super_admin: 'è¶…çº§ç®¡ç†å‘˜'
                };
                return roleMap[role] || role;
            }

            getStatusText(status) {
                const statusMap = {
                    pending: 'å¾…å®¡æ ¸',
                    approved: 'å·²é€šè¿‡',
                    rejected: 'å·²æ‹’ç»',
                    suspended: 'å·²æš‚åœ'
                };
                return statusMap[status] || status;
            }

            bindEventListeners() {
                document.getElementById('update-role-btn').addEventListener('click', () => this.updateRole());
                document.getElementById('update-status-btn').addEventListener('click', () => this.updateStatus());
                document.getElementById('create-test-user-btn').addEventListener('click', () => this.createTestUser());
                document.getElementById('test-data-btn').addEventListener('click', () => this.generateTestData());
                document.getElementById('clear-data-btn').addEventListener('click', () => this.clearTestData());
            }

            async updateRole() {
                const role = document.getElementById('role-select').value;
                
                try {
                    const { error } = await supabase
                        .from('profiles')
                        .update({ role })
                        .eq('id', this.currentUser.id);

                    if (error) throw error;

                    this.log(`è§’è‰²å·²æ›´æ–°ä¸º: ${this.getRoleText(role)}`, 'success');
                    
                    // æ›´æ–°navbar
                    if (window.navbar) {
                        window.navbar.onLogin(this.currentUser.email, role);
                    }

                    await this.loadCurrentUser();
                } catch (error) {
                    this.log('æ›´æ–°è§’è‰²å¤±è´¥: ' + error.message, 'error');
                }
            }

            async updateStatus() {
                const status = document.getElementById('status-select').value;
                
                try {
                    const { error } = await supabase
                        .from('profiles')
                        .update({ status })
                        .eq('id', this.currentUser.id);

                    if (error) throw error;

                    this.log(`çŠ¶æ€å·²æ›´æ–°ä¸º: ${this.getStatusText(status)}`, 'success');
                    await this.loadCurrentUser();
                } catch (error) {
                    this.log('æ›´æ–°çŠ¶æ€å¤±è´¥: ' + error.message, 'error');
                }
            }

            async createTestUser() {
                const email = document.getElementById('test-email').value;
                const name = document.getElementById('test-name').value;
                const status = document.getElementById('test-status').value;

                if (!email || !name) {
                    this.log('è¯·å¡«å†™é‚®ç®±å’Œå§“å', 'error');
                    return;
                }

                try {
                    // ç›´æ¥æ’å…¥åˆ°profilesè¡¨
                    const testUserId = crypto.randomUUID();
                    const { error } = await supabase
                        .from('profiles')
                        .insert({
                            id: testUserId,
                            email: email,
                            full_name: name,
                            status: status,
                            role: 'user',
                            created_at: new Date().toISOString()
                        });

                    if (error) throw error;

                    this.log(`æµ‹è¯•ç”¨æˆ·å·²åˆ›å»º: ${name} (${email})`, 'success');
                    
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('test-email').value = '';
                    document.getElementById('test-name').value = '';
                } catch (error) {
                    this.log('åˆ›å»ºæµ‹è¯•ç”¨æˆ·å¤±è´¥: ' + error.message, 'error');
                }
            }

            async generateTestData() {
                const testUsers = [
                    { email: 'test1@example.com', name: 'å¼ ä¸‰', status: 'pending' },
                    { email: 'test2@example.com', name: 'æå››', status: 'pending' },
                    { email: 'test3@example.com', name: 'ç‹äº”', status: 'approved' },
                    { email: 'test4@example.com', name: 'èµµå…­', status: 'rejected' },
                    { email: 'test5@example.com', name: 'é’±ä¸ƒ', status: 'suspended' }
                ];

                try {
                    const testUsersData = testUsers.map(user => ({
                        id: crypto.randomUUID(),
                        email: user.email,
                        full_name: user.name,
                        status: user.status,
                        role: 'user',
                        organization: 'æµ‹è¯•æœºæ„',
                        created_at: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString()
                    }));

                    const { error } = await supabase
                        .from('profiles')
                        .insert(testUsersData);

                    if (error) throw error;

                    this.log(`å·²ç”Ÿæˆ ${testUsers.length} ä¸ªæµ‹è¯•ç”¨æˆ·`, 'success');
                } catch (error) {
                    this.log('ç”Ÿæˆæµ‹è¯•æ•°æ®å¤±è´¥: ' + error.message, 'error');
                }
            }

            async clearTestData() {
                if (!confirm('ç¡®å®šè¦æ¸…ç†æ‰€æœ‰æµ‹è¯•æ•°æ®å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰é‚®ç®±åŒ…å«"test"æˆ–"example"çš„ç”¨æˆ·ã€‚')) {
                    return;
                }

                try {
                    const { error } = await supabase
                        .from('profiles')
                        .delete()
                        .or('email.like.%test%,email.like.%example%');

                    if (error) throw error;

                    this.log('æµ‹è¯•æ•°æ®å·²æ¸…ç†', 'success');
                } catch (error) {
                    this.log('æ¸…ç†æµ‹è¯•æ•°æ®å¤±è´¥: ' + error.message, 'error');
                }
            }

            log(message, type = 'info') {
                const logDiv = document.getElementById('operation-log');
                const timestamp = new Date().toLocaleTimeString();
                const color = type === 'success' ? 'text-green-600' : type === 'error' ? 'text-red-600' : 'text-blue-600';
                
                const logEntry = document.createElement('div');
                logEntry.className = `text-sm ${color} mb-1`;
                logEntry.textContent = `[${timestamp}] ${message}`;
                
                logDiv.insertBefore(logEntry, logDiv.firstChild);
                
                // ä¿æŒæœ€å¤š20æ¡æ—¥å¿—
                while (logDiv.children.length > 20) {
                    logDiv.removeChild(logDiv.lastChild);
                }
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            new AdminSetup();
        });
    </script>
</body>
</html>
